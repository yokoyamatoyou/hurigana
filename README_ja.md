# フリガナチェッカー利用ガイド

このリポジトリには、Excel ファイルから人名とフリガナを読み込み、
読みの信頼度を算出して結果を上書き保存する Streamlit アプリケーションが含まれています。

## 起動方法

1. **Python 3.11** を用意してください。
2. 依存パッケージをインストールします。
   ```bash
   pip install -r requirements.txt
   ```
   もしくは
   ```bash
   pip install sudachipy sudachidict-full openai pandas streamlit openpyxl xlsxwriter
   ```
3. OpenAI API キーを環境変数 `OPENAI_API_KEY` に設定します。
   ```bash
   export OPENAI_API_KEY="sk-..."
   ```
4. 以下のコマンドでアプリを起動します。
   ```bash
   streamlit run app.py
   ```
   Windows 環境では `run_app.bat` から起動することもできます。

## 使用方法

アプリを起動するとファイルアップロード画面が表示されます。処理対象の
Excel ファイルを選択し、名前列とフリガナ列をプルダウンから指定して実行すると、
各行ごとに算出した信頼度と理由が追加されたファイルをダウンロードできます。

大量の行を処理する場合は、内部で重複する名前をまとめてから GPT へ問い合わせるため、
同じ名前が何度も出現しても API の呼び出し回数は増えません。

## チェックのアルゴリズム

1. **SudachiPy** により名前を形態素解析し、得られた読みが元のフリガナと
   一致した場合は信頼度を 100、理由を「辞書候補1位一致」とします。
2. SudachiPy で一致しない場合、名前を GPT に送信して候補読みを取得します。
   温度 0.0 で 3 件、0.7 で 5 件の候補を順に生成し、重複は除外します。
3. SudachiPy の候補結果が存在する場合は候補リストの先頭に追加し、最大で
   9 件の候補を作成します。
4. 与えられたフリガナが候補のどこに位置するかに応じて
   `calc_confidence` が以下のように点数を返します。
   - Sudachi 候補一致: 100
   - 低温候補1～3位: 99, 90, 80
   - 高温候補1～5位: 70, 60, 50, 40, 30
   - それ以外: 0（理由は「候補外･要確認」）
5. 処理結果はデータフレームに信頼度と理由の列を追加し、Excel へ書き戻します。

アルゴリズムはバッチ処理と指数バックオフによるリトライを備え、
長い名前（50 文字超）には自動で 0 点を返します。
