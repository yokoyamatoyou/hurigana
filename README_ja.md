# フリガナチェッカー利用ガイド

このリポジトリには、Excel ファイルから人名とフリガナを読み込み、
読みの信頼度を算出して結果を上書き保存する Streamlit アプリケーションが含まれています。

## 起動方法

1. **Python 3.11** を用意してください。
2. 依存パッケージをインストールします。
   ```bash
   pip install -r requirements.txt
   ```
   もしくは
   ```bash
   pip install sudachipy sudachidict-full openai pandas streamlit openpyxl xlsxwriter
   ```
3. OpenAI API キーを環境変数 `OPENAI_API_KEY` に設定します。
   ```bash
   export OPENAI_API_KEY="sk-..."
   ```
   デフォルトのモデルは `gpt-4.1-mini-2025-04-14` （ナレッジカットオフ 2025-04-14）です。
   必要に応じて `OPENAI_MODEL` 環境変数で変更できます。
4. 以下のコマンドでアプリを起動します。
   ```bash
   streamlit run app.py
   ```
   Windows 環境では `run_app.bat` から起動することもできます。

## 使用方法

アプリを起動するとファイルアップロード画面が表示されます。処理対象の
Excel ファイルを選択し、名前列とフリガナ列をプルダウンから指定して実行すると、
各行ごとに算出した信頼度と理由が追加されたファイルをダウンロードできます。

大量の行を処理する場合は、内部で重複する名前をまとめてから GPT へ問い合わせるため、
同じ名前が何度も出現しても API の呼び出し回数は増えません。

## チェックのアルゴリズム

1. **SudachiPy** により名前を形態素解析し、得られた読みが元のフリガナと
   一致した場合は信頼度を 100、理由を「辞書候補一致」とします。
2. SudachiPy で一致しない場合は ``parser.sudachi_reading`` の結果を候補の先頭
    に置き、さらに GPT へ 2 回問い合わせて候補を増やします。
    - 温度 0.0 で 3 件
    - 温度 0.7 で 5 件
    得られた読みは正規化して重複を除去します。
 3. 上記の手順で作成した候補は最大 9 件まで保存されます。
4. 与えられたフリガナが候補の何番目に位置するかに応じて
   `calc_confidence` が以下のように点数を返します。
   - 辞書候補一致: 100
   - 候補1位一致: 85
   - 候補2位一致: 80
   - 候補3位一致: 70
   - 5位内一致: 60
   - その他: 0
5. 処理結果はデータフレームに信頼度と理由の列を追加し、Excel へ書き戻します。

アルゴリズムはバッチ処理と指数バックオフによるリトライを備え、
長い名前（50 文字超）には自動で 0 点を返します。
